<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Town - Virtual AI Community</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .world-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .world-view {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .world-canvas {
            border: 2px solid #ddd;
            border-radius: 10px;
            background: #f8f9fa;
            display: block;
            margin: 0 auto;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #667eea;
            font-size: 1.2em;
        }

        .agent-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .agent-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .agent-name {
            font-weight: bold;
            color: #333;
        }

        .agent-status {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .conversation-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .conversation-speaker {
            font-weight: bold;
            color: #667eea;
        }

        .conversation-message {
            margin-top: 5px;
            color: #333;
        }

        .conversation-time {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running {
            background: #28a745;
        }

        .status-stopped {
            background: #dc3545;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .building-house { background: #8B4513; }
        .building-cafe { background: #D2691E; }
        .building-park { background: #228B22; }
        .building-shop { background: #4169E1; }
        .building-office { background: #708090; }

        @media (max-width: 768px) {
            .world-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¤– AI Town</h1>
            <p>Watch AI agents live, chat, and socialize in real-time</p>
        </div>

        <div class="controls">
            <div>
                <button class="btn btn-primary" onclick="startSimulation()">
                    <span class="status-indicator status-stopped" id="statusIndicator"></span>
                    Start Simulation
                </button>
                <button class="btn btn-danger" onclick="stopSimulation()">Stop</button>
            </div>
            
            <div class="input-group">
                <input type="password" id="apiKey" placeholder="OpenRouter API Key" />
                <button class="btn btn-secondary" onclick="saveApiKey()">Save Key</button>
            </div>
            
            <div class="input-group">
                <input type="text" id="agentName" placeholder="Agent Name" />
                <input type="text" id="agentPersonality" placeholder="Personality" />
                <button class="btn btn-primary" onclick="addAgent()">Add Agent</button>
            </div>
        </div>

        <div class="world-container">
            <div class="world-view">
                <h3>World View</h3>
                <canvas id="worldCanvas" class="world-canvas" width="600" height="400"></canvas>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color building-house"></div>
                        <span>House</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color building-cafe"></div>
                        <span>Cafe</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color building-park"></div>
                        <span>Park</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color building-shop"></div>
                        <span>Shop</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color building-office"></div>
                        <span>Office</span>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="panel">
                    <h3>Agents</h3>
                    <div id="agentList" class="agent-list">
                        <p>No agents yet. Start the simulation to see agents.</p>
                    </div>
                </div>

                <div class="panel">
                    <h3>Recent Conversations</h3>
                    <div id="conversationFeed" class="conversation-feed">
                        <p>No conversations yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let worldState = null;
        let canvas = null;
        let ctx = null;
        let cellSize = 12;
        let isSimulationRunning = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('worldCanvas');
            ctx = canvas.getContext('2d');
            
            // Load saved API key
            const savedKey = localStorage.getItem('openrouter_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
        });

        function saveApiKey() {
            const key = document.getElementById('apiKey').value;
            localStorage.setItem('openrouter_api_key', key);
            alert('API key saved!');
        }

        function startSimulation() {
            const apiKey = document.getElementById('apiKey').value || localStorage.getItem('openrouter_api_key');
            if (!apiKey) {
                alert('Please enter your OpenRouter API key');
                return;
            }

            if (!socket) {
                socket = io();
                
                socket.on('connect', function() {
                    console.log('Connected to server');
                    socket.emit('start_simulation', {api_key: apiKey});
                });

                socket.on('simulation_started', function(data) {
                    console.log(data.message);
                    isSimulationRunning = true;
                    updateStatusIndicator();
                });

                socket.on('world_update', function(state) {
                    worldState = state;
                    renderWorld();
                    updateAgentList();
                    updateConversationFeed();
                });

                socket.on('error', function(data) {
                    alert('Error: ' + data.message);
                });
            } else {
                socket.emit('start_simulation', {api_key: apiKey});
            }
        }

        function stopSimulation() {
            if (socket) {
                socket.emit('stop_simulation');
                socket.on('simulation_stopped', function(data) {
                    console.log(data.message);
                    isSimulationRunning = false;
                    updateStatusIndicator();
                });
            }
        }

        function addAgent() {
            const name = document.getElementById('agentName').value;
            const personality = document.getElementById('agentPersonality').value;
            
            if (!name || !personality) {
                alert('Please enter both name and personality');
                return;
            }

            if (socket) {
                socket.emit('add_agent', {name: name, personality: personality});
                document.getElementById('agentName').value = '';
                document.getElementById('agentPersonality').value = '';
            } else {
                alert('Please start the simulation first');
            }
        }

        function updateStatusIndicator() {
            const indicator = document.getElementById('statusIndicator');
            if (isSimulationRunning) {
                indicator.className = 'status-indicator status-running';
            } else {
                indicator.className = 'status-indicator status-stopped';
            }
        }

        function renderWorld() {
            if (!worldState) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let x = 0; x <= worldState.width; x++) {
                ctx.beginPath();
                ctx.moveTo(x * cellSize, 0);
                ctx.lineTo(x * cellSize, worldState.height * cellSize);
                ctx.stroke();
            }
            for (let y = 0; y <= worldState.height; y++) {
                ctx.beginPath();
                ctx.moveTo(0, y * cellSize);
                ctx.lineTo(worldState.width * cellSize, y * cellSize);
                ctx.stroke();
            }

            // Draw buildings
            worldState.buildings.forEach(building => {
                const x = building.position.x * cellSize;
                const y = building.position.y * cellSize;
                const width = building.size[0] * cellSize;
                const height = building.size[1] * cellSize;

                ctx.fillStyle = getBuildingColor(building.type);
                ctx.fillRect(x, y, width, height);
                
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, width, height);
            });

            // Draw agents
            worldState.agents.forEach(agent => {
                const x = agent.position.x * cellSize + cellSize/2;
                const y = agent.position.y * cellSize + cellSize/2;
                
                ctx.fillStyle = getAgentColor(agent.mood);
                ctx.beginPath();
                ctx.arc(x, y, cellSize/2 - 2, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Draw agent name
                ctx.fillStyle = '#333';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(agent.name, x, y - cellSize/2 - 2);
            });
        }

        function getBuildingColor(type) {
            const colors = {
                'house': '#8B4513',
                'cafe': '#D2691E',
                'park': '#228B22',
                'shop': '#4169E1',
                'office': '#708090'
            };
            return colors[type] || '#999';
        }

        function getAgentColor(mood) {
            const colors = {
                'happy': '#FFD700',
                'sad': '#4169E1',
                'angry': '#DC143C',
                'neutral': '#90EE90',
                'excited': '#FF69B4'
            };
            return colors[mood] || '#90EE90';
        }

        function updateAgentList() {
            if (!worldState) return;

            const agentList = document.getElementById('agentList');
            if (worldState.agents.length === 0) {
                agentList.innerHTML = '<p>No agents yet.</p>';
                return;
            }

            agentList.innerHTML = worldState.agents.map(agent => `
                <div class="agent-item">
                    <div class="agent-name">${agent.name}</div>
                    <div class="agent-status">
                        ${agent.current_action}<br>
                        Position: (${agent.position.x}, ${agent.position.y})
                    </div>
                </div>
            `).join('');
        }

        function updateConversationFeed() {
            if (!worldState) return;

            const feed = document.getElementById('conversationFeed');
            if (worldState.conversations.length === 0) {
                feed.innerHTML = '<p>No conversations yet.</p>';
                return;
            }

            feed.innerHTML = worldState.conversations.map(conv => `
                <div class="conversation-item">
                    <div class="conversation-speaker">${conv.speaker}</div>
                    <div class="conversation-message">${conv.message}</div>
                    <div class="conversation-time">${new Date(conv.timestamp).toLocaleTimeString()}</div>
                </div>
            `).join('');
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (worldState) {
                renderWorld();
            }
        });
    </script>
</body>
</html>
